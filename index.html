<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友世界地图 </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            color: #1a2a6c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            color: #555;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .app-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        .map-container {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #map {
            flex: 1;
            width: 100%;
            z-index: 10;
        }
        
        .map-controls {
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .friends-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 400px;
            height: 100%;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            position: relative;
        }
        
        .friends-list-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .friends-search {
            margin-bottom: 15px;
            position: relative;
        }
        
        .friends-search input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .friends-search input:focus {
            border-color: #1a2a6c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.2);
        }
        
        .friends-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100vh - 350px);
        }
        
        .friends-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .friends-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .friends-list::-webkit-scrollbar-thumb {
            background: #1a2a6c;
            border-radius: 4px;
        }
        
        .friends-list::-webkit-scrollbar-thumb:hover {
            background: #0d1a4a;
        }
        
        .friend-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .friend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #1a2a6c;
        }
        
        .friend-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            border: 3px solid #1a2a6c;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .friend-avatar .avatar-placeholder {
            font-size: 24px;
            color: #1a2a6c;
        }
        
        .friend-info {
            flex: 1;
        }
        
        .friend-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #1a2a6c;
            margin-bottom: 5px;
        }
        
        .friend-location {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .friend-location i {
            margin-right: 5px;
            color: #e74c3c;
        }
        
        .friend-card-body {
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .friend-coords {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #777;
        }
        
        .friend-coords i {
            margin-right: 8px;
            color: #3498db;
        }
        
        .friend-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .friend-card:hover .friend-actions {
            opacity: 1;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-btn {
            background: #3498db;
            color: white;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .friend-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transition: all 0.3s;
            z-index: 500;
        }
        
        .friend-marker:hover {
            transform: scale(1.15);
            z-index: 1000;
        }
        
        .friend-marker img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        
        .location-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            z-index: 400;
        }
        
        .connection-line {
            stroke: #ff6b6b;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 30s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: 1000;
            }
        }
        
        .map-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 380px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s ease;
        }
        
        .map-overlay:hover {
            transform: translateY(-5px);
        }
        
        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .overlay-header h3 {
            color: #1a2a6c;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .overlay-header h3 i {
            margin-right: 10px;
        }
        
        .close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            transform: rotate(90deg);
            background: #e74c3c;
        }
        
        .avatar-upload {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .avatar-preview {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #1a2a6c;
            margin-right: 15px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-preview .placeholder {
            color: #1a2a6c;
            font-size: 24px;
        }
        
        .upload-btn {
            flex: 1;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        #avatar-file {
            display: none;
        }
        
        .world-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 25rem;
            color: rgba(255, 255, 255, 0.03);
            z-index: 0;
        }
        
        .admin-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .admin-indicator {
            display: flex;
            align-items: center;
            color: #27ae60;
            font-weight: bold;
        }
        
        .admin-indicator i {
            margin-right: 5px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .login-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-weight: bold;
            color: #1a2a6c;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .login-btn i {
            color: #27ae60;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #1a2a6c;
            font-size: 1.8rem;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 30px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .floating-element {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }
        
        .geocoding-result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .edit-modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .edit-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .map-switcher {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .map-type-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-type-btn:hover {
            background: #f8f9fa;
            border-color: #1a2a6c;
        }
        
        .map-type-btn.active {
            background: #1a2a6c;
            color: white;
            border-color: #1a2a6c;
        }
        
        .no-friends {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }
            
            .friends-panel {
                max-width: 100%;
                height: 400px;
            }
            
            .friends-list {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> 好友世界地图 </h1>
            <p class="subtitle">查看好友在世界各地的位置，上传头像并管理好友信息</p>
        </header>
        <div class="top-toolbar" style="display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:10px;">
          <button id="share-btn" style="background:#3498db;color:#fff;border:none;border-radius:6px;padding:8px 18px;cursor:pointer;font-size:1rem;">
            <i class="fas fa-share-alt"></i> 分享当前视图
          </button>
        </div>
        <div id="share-panel" style="display:none;position:absolute;top:80px;right:40px;background:#fff;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,0.15);padding:18px;z-index:3000;">
          <input type="text" id="share-link" readonly style="width:260px;padding:6px 10px;border:1px solid #ccc;border-radius:5px;margin-bottom:10px;">
          <button onclick="copyShareLink()" style="margin-left:8px;background:#27ae60;color:#fff;border:none;border-radius:5px;padding:6px 16px;cursor:pointer;">复制链接</button>
          <div class="social-share" style="margin-top:10px;display:flex;gap:12px;">
            <a href="#" id="wechat-share" title="微信分享" style="font-size:1.5rem;color:#1aad19;"><i class="fab fa-weixin"></i></a>
            <a href="#" id="qq-share" title="QQ分享" style="font-size:1.5rem;color:#12b7f5;"><i class="fab fa-qq"></i></a>
          </div>
        </div>
        
        <div class="app-container">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button id="add-location-btn"><i class="fas fa-plus-circle"></i> 添加位置</button>
                    <button id="reset-map-btn"><i class="fas fa-globe-americas"></i> 重置视图</button>
                    <div class="map-switcher">
                        <button class="map-type-btn active" data-type="osm">
                            <i class="fas fa-map"></i> 卫星地图
                        </button>
                        <button class="map-type-btn" data-type="satellite">
                            <i class="fas fa-satellite"></i> 标准地图
                        </button>
                        <button class="map-type-btn" data-type="terrain">
                            <i class="fas fa-mountain"></i> 地形地图
                        </button>
                    </div>
                </div>
                <div class="map-overlay">
                    <div class="overlay-header">
                        <h3><i class="fas fa-user-plus"></i> 添加好友位置</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            <div class="placeholder"><i class="fas fa-user"></i></div>
                            <img id="avatar-preview" style="display: none;">
                        </div>
                        <label class="upload-btn" for="avatar-file">
                            <i class="fas fa-upload"></i> 上传头像
                        </label>
                        <input type="file" id="avatar-file" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="friend-name"><i class="fas fa-user"></i> 好友姓名</label>
                        <input type="text" id="friend-name" placeholder="输入好友姓名">
                    </div>
                    <div class="form-group">
                        <label for="location"><i class="fas fa-map-marker-alt"></i> 位置（城市或经纬度）</label>
                        <input type="text" id="location" placeholder="例如: 北京 或 40.7128,-74.0060">
                    </div>
                    <div class="geocoding-result" id="geocoding-result" style="display: none;">
                        正在解析位置...
                    </div>
                    <button id="add-friend-btn"><i class="fas fa-plus"></i> 添加好友位置</button>
                </div>
                <i class="fas fa-globe-americas world-icon"></i>
            </div>
            
            <div class="friends-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-user-friends"></i> 好友列表</h2>
                    <div class="admin-indicator" id="admin-indicator" style="display: none;">
                        <i class="fas fa-user-shield"></i> 管理员模式
                    </div>
                </div>
                <div class="friends-list-container">
                    <div class="friends-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="friend-search" placeholder="搜索好友...">
                    </div>
                    <div class="friends-list" id="friends-list">
                        <!-- 好友列表会动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="login-btn" id="admin-login-btn">
        <i class="fas fa-lock"></i> 管理员登录
    </button>
    
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-header">
                <h3>管理员登录</h3>
                <p>请输入管理员密码</p>
            </div>
            <div class="form-group">
                <input type="password" id="admin-password" placeholder="输入管理员密码">
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="login-submit">登录</button>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div>正在解析位置，请稍候...</div>
    </div>
    
    <div class="edit-modal" id="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <span class="edit-modal-close" onclick="closeEditModal()">&times;</span>
            <div class="modal-header">
                <h3>编辑好友信息</h3>
            </div>
            <div class="avatar-upload">
                <div class="avatar-preview">
                    <img id="edit-avatar-preview">
                </div>
                <label class="upload-btn" for="edit-avatar-file">
                    <i class="fas fa-upload"></i> 更换头像
                </label>
                <input type="file" id="edit-avatar-file" accept="image/*" style="display: none;">
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> 好友姓名</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-group">
                <label><i class="fas fa-map-marker-alt"></i> 位置</label>
                <input type="text" id="edit-location">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> 管理员密码验证</label>
                <input type="password" id="admin-verify">
            </div>
            <button class="modal-btn" id="save-edit-btn">保存修改</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 初始化地图
        const map = L.map('map').setView([30, 0], 2);
        
        // 地图图层定义
        const mapLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
            })
        };
        
        // 添加默认地图
        mapLayers.satellite.addTo(map);
        
        // 存储好友数据
        let friends = JSON.parse(localStorage.getItem('friends')) || [];
        
        // 存储标记和指引线
        const markers = [];
        const connectionLines = [];
        const locationPoints = [];
        
        // 当前选择的头像
        let selectedAvatar = null;
        
        // 管理员状态
        let isAdmin = false;
        
        // 当前编辑的好友ID
        let currentEditFriendId = null;
        
        // 添加好友到地图
        function addFriendToMap(friend) {
            // 创建位置点标记
            const pointIcon = L.divIcon({
                className: 'location-point',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            const locationPoint = L.marker(friend.position, {icon: pointIcon}).addTo(map);
            
            // 创建自定义头像图标
            const avatarIcon = L.divIcon({
                className: 'friend-marker',
                html: `<img src="${friend.avatar}" alt="${friend.name}">`,
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });
            
            // 计算偏移位置（避免同一位置重叠）
            const offsetPosition = calculateOffsetPosition(friend.position, friend.id);
            
            // 添加头像标记
            const avatarMarker = L.marker(offsetPosition, {icon: avatarIcon}).addTo(map);
            
            // 添加弹出信息
            avatarMarker.bindPopup(`
                <div style="text-align:center;padding:10px">
                    <img src="${friend.avatar}" alt="${friend.name}" style="width:80px;height:80px;border-radius:50%;border:3px solid #1a2a6c;margin-bottom:10px;">
                    <h3 style="margin-bottom:5px;color:#1a2a6c">${friend.name}</h3>
                    <p style="color:#666">${friend.location}</p>
                    <p style="color:#888;margin-top:10px;font-size:0.9rem">纬度: ${friend.position[0].toFixed(4)}<br>经度: ${friend.position[1].toFixed(4)}</p>
                </div>
            `);
            
            // 添加指引线
            const line = L.polyline([friend.position, offsetPosition], {
                color: '#ff6b6b',
                weight: 3,
                dashArray: '10, 5'
            }).addTo(map);
            
            // 动画效果
            animateConnectionLine(line, friend.position, offsetPosition);
            
            // 保存到数组
            markers.push({avatarMarker, line, id: friend.id});
            locationPoints.push({locationPoint, id: friend.id});
        }
        
        // 计算偏移位置（避免同一位置重叠）
        function calculateOffsetPosition(position, id) {
            const sameLocationFriends = friends.filter(f => 
                f.position[0].toFixed(4) === position[0].toFixed(4) && 
                f.position[1].toFixed(4) === position[1].toFixed(4)
            );
            
            const index = sameLocationFriends.findIndex(f => f.id === id);
            const count = sameLocationFriends.length;
            
            // 偏移角度和距离
            const angle = (index * 360) / count;
            const distance = 0.1; // 偏移距离（度）
            
            // 将角度转换为弧度
            const radian = angle * Math.PI / 180;
            
            // 计算偏移位置
            const offsetLat = position[0] + distance * Math.sin(radian);
            const offsetLng = position[1] + distance * Math.cos(radian);
            
            return [offsetLat, offsetLng];
        }
        
        // 指引线动画效果
        function animateConnectionLine(line, startPos, endPos) {
            // 设置初始位置
            line.setLatLngs([startPos, startPos]);
            
            // 动画移动到实际位置
            setTimeout(() => {
                line.setLatLngs([startPos, endPos]);
            }, 1000);
        }
        
        // 添加好友到列表
        function addFriendToList(friend) {
            const friendsList = document.getElementById('friends-list');
            
            const friendCard = document.createElement('div');
            friendCard.className = 'friend-card';
            friendCard.dataset.id = friend.id;
            friendCard.innerHTML = `
                <div class="friend-card-header">
                    <div class="friend-avatar">
                        <img src="${friend.avatar}" alt="${friend.name}">
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-location">
                            <i class="fas fa-map-marker-alt"></i> ${friend.location}
                        </div>
                    </div>
                </div>
                <div class="friend-card-body">
                    <div class="friend-coords">
                        <i class="fas fa-location-dot"></i> 
                        纬度: ${friend.position[0].toFixed(4)}, 经度: ${friend.position[1].toFixed(4)}
                    </div>
                    <div class="friend-coords">
                        <i class="fas fa-calendar-alt"></i> 
                        添加时间: ${new Date(friend.id).toLocaleDateString()}
                    </div>
                </div>
                <div class="friend-actions">
                    <button class="action-btn edit-btn" data-id="${friend.id}">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                    <button class="action-btn delete-btn" data-id="${friend.id}">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            `;
            
            friendCard.querySelector('.friend-actions').style.display = isAdmin ? 'flex' : 'none';
            
            friendCard.addEventListener('click', (e) => {
                if (!e.target.closest('.action-btn')) {
                    map.flyTo(friend.position, 5, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    setTimeout(() => {
                        const marker = markers.find(m => m.id === friend.id)?.avatarMarker;
                        if (marker) marker.openPopup();
                    }, 1600);
                }
            });
            
            friendsList.appendChild(friendCard);
        }
        
        // 更新好友列表
        function updateFriendsList(searchTerm = '') {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '';
            
            // 按名称首字母排序
            const sortedFriends = [...friends].sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            // 过滤好友
            const filteredFriends = sortedFriends.filter(friend => {
                if (!searchTerm) return true;
                return friend.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       friend.location.toLowerCase().includes(searchTerm.toLowerCase());
            });
            
            if (filteredFriends.length === 0) {
                friendsList.innerHTML = `
                    <div class="no-friends">
                        <i class="fas fa-user-slash" style="font-size:3rem;margin-bottom:15px;"></i>
                        <h3>没有找到匹配的好友</h3>
                        <p>尝试使用不同的搜索词</p>
                    </div>
                `;
                return;
            }
            
            filteredFriends.forEach(friend => addFriendToList(friend));
        }
        
        // 更新管理员UI
        function updateAdminUI() {
            document.getElementById('admin-login-btn').style.display = isAdmin ? 'none' : 'block';
            
            // 显示管理员指示器
            document.getElementById('admin-indicator').style.display = isAdmin ? 'flex' : 'none';
            
            // 更新好友卡片中的操作按钮
            document.querySelectorAll('.friend-actions').forEach(actions => {
                actions.style.display = isAdmin ? 'flex' : 'none';
            });
        }
        
        // 地理编码函数 - 将中文地址转换为经纬度
        async function geocodeAddress(address) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('geocoding-result').style.display = 'block';
            document.getElementById('geocoding-result').textContent = '正在解析位置...';
            
            try {
                // 使用Nominatim地理编码服务
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
                );
                
                if (!response.ok) {
                    throw new Error('地理编码服务请求失败');
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    throw new Error('未找到匹配的位置');
                }
                
                // 获取第一个结果
                const firstResult = data[0];
                const lat = parseFloat(firstResult.lat);
                const lon = parseFloat(firstResult.lon);
                
                document.getElementById('geocoding-result').textContent = 
                    `解析成功: ${firstResult.display_name || address}`;
                
                return [lat, lon];
            } catch (error) {
                document.getElementById('geocoding-result').textContent = 
                    `解析失败: ${error.message || '未知错误'}`;
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 添加好友函数
        async function addFriend(name, avatar, location) {
            let position = null;
            
            // 检查输入是否是经纬度
            if (location.includes(',')) {
                const coords = location.split(',').map(coord => parseFloat(coord.trim()));
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    position = coords;
                }
            }
            
            // 如果不是经纬度，则进行地理编码
            if (!position) {
                position = await geocodeAddress(location);
                
                if (!position) {
                    alert('无法解析位置，请检查输入或稍后再试');
                    return;
                }
            }
            
            const friend = {
                id: Date.now(),
                name: name,
                avatar: avatar || 'https://ui-avatars.com/api/?name=' + name + '&background=1a2a6c&color=fff',
                location: location,
                position: position
            };
            
            friends.push(friend);
            localStorage.setItem('friends', JSON.stringify(friends));
            
            addFriendToMap(friend);
            updateFriendsList();
            
            // 动画效果
            map.flyTo(position, 5, {
                animate: true,
                duration: 1.5
            });
            
            // 重置表单
            document.getElementById('friend-name').value = '';
            document.getElementById('location').value = '';
            document.getElementById('avatar-preview').style.display = 'none';
            document.querySelector('.avatar-preview .placeholder').style.display = 'block';
            selectedAvatar = null;
            
            // 隐藏地理编码结果
            setTimeout(() => {
                document.getElementById('geocoding-result').style.display = 'none';
            }, 3000);
        }
        
        // 删除好友
        function deleteFriend(id) {
            // 从数组中删除
            friends = friends.filter(friend => friend.id !== id);
            localStorage.setItem('friends', JSON.stringify(friends));
            
            // 从地图上删除
            const markerIndex = markers.findIndex(m => m.id === id);
            if (markerIndex !== -1) {
                map.removeLayer(markers[markerIndex].avatarMarker);
                map.removeLayer(markers[markerIndex].line);
                markers.splice(markerIndex, 1);
            }
            
            const pointIndex = locationPoints.findIndex(p => p.id === id);
            if (pointIndex !== -1) {
                map.removeLayer(locationPoints[pointIndex].locationPoint);
                locationPoints.splice(pointIndex, 1);
            }
            
            // 更新列表
            updateFriendsList(document.getElementById('friend-search').value);
        }
        
        // 初始化好友数据
        function initializeFriends() {
            // 添加示例好友
            if (friends.length === 0) {
                // 使用真实的坐标添加示例好友
                const sampleFriends = [
                    {name: '张三', avatar: 'https://randomuser.me/api/portraits/men/22.jpg', location: '北京', position: [39.9042, 116.4074]},
                    {name: '李四', avatar: 'https://randomuser.me/api/portraits/women/44.jpg', location: '纽约', position: [40.7128, -74.0060]},
                    {name: '王五', avatar: 'https://randomuser.me/api/portraits/men/62.jpg', location: '伦敦', position: [51.5074, -0.1278]},
                    {name: '赵六', avatar: 'https://randomuser.me/api/portraits/women/68.jpg', location: '悉尼', position: [-33.8688, 151.2093]},
                    {name: '钱七', avatar: 'https://randomuser.me/api/portraits/men/32.jpg', location: '北京', position: [39.9042, 116.4074]},
                    {name: '孙八', avatar: 'https://randomuser.me/api/portraits/women/28.jpg', location: '北京', position: [39.9042, 116.4074]},
                    {name: '周九', avatar: 'https://randomuser.me/api/portraits/men/45.jpg', location: '上海', position: [31.2304, 121.4737]},
                    {name: '吴十', avatar: 'https://randomuser.me/api/portraits/women/33.jpg', location: '广州', position: [23.1291, 113.2644]},
                    {name: '郑十一', avatar: 'https://randomuser.me/api/portraits/men/28.jpg', location: '深圳', position: [22.5431, 114.0579]},
                    {name: '王十二', avatar: 'https://randomuser.me/api/portraits/women/22.jpg', location: '成都', position: [30.5728, 104.0668]}
                ];
                
                sampleFriends.forEach(friend => {
                    const id = Date.now();
                    friends.push({...friend, id});
                    addFriendToMap({...friend, id});
                });
            } else {
                friends.forEach(friend => {
                    addFriendToMap(friend);
                });
            }
            
            // 初始渲染好友列表
            updateFriendsList();
        }
        
        // 打开编辑模态框
        function openEditModal(friend) {
            currentEditFriendId = friend.id;
            document.getElementById('edit-avatar-preview').src = friend.avatar;
            document.getElementById('edit-name').value = friend.name;
            document.getElementById('edit-location').value = friend.location;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditFriendId = null;
        }
        
        // 保存编辑
        async function saveEdit() {
            if (!currentEditFriendId) return;
            
            const password = document.getElementById('admin-verify').value;
            if (password !== "5201314") {
                alert("管理员密码错误");
                return;
            }
            
            const friend = friends.find(f => f.id === currentEditFriendId);
            if (!friend) return;
            
            const newName = document.getElementById('edit-name').value;
            const newLocation = document.getElementById('edit-location').value;
            const newAvatar = document.getElementById('edit-avatar-preview').src;
            
            // 更新位置需重新地理编码
            if (newLocation !== friend.location) {
                const newPos = await geocodeAddress(newLocation);
                if (!newPos) {
                    alert('无法解析新位置，请检查输入');
                    return;
                }
                friend.position = newPos;
                friend.location = newLocation;
                
                // 更新地图标记
                const markerData = markers.find(m => m.id === friend.id);
                const pointData = locationPoints.find(p => p.id === friend.id);
                if (markerData && pointData) {
                    // 移除旧标记
                    map.removeLayer(markerData.avatarMarker);
                    map.removeLayer(markerData.line);
                    map.removeLayer(pointData.locationPoint);
                    
                    // 添加新标记
                    const pointIcon = L.divIcon({
                        className: 'location-point',
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    
                    const newLocationPoint = L.marker(newPos, {icon: pointIcon}).addTo(map);
                    
                    // 计算偏移位置
                    const offsetPosition = calculateOffsetPosition(newPos, friend.id);
                    
                    const avatarIcon = L.divIcon({
                        className: 'friend-marker',
                        html: `<img src="${newAvatar}" alt="${newName}">`,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });
                    
                    const newAvatarMarker = L.marker(offsetPosition, {icon: avatarIcon}).addTo(map);
                    
                    newAvatarMarker.bindPopup(`
                        <div style="text-align:center;padding:10px">
                            <img src="${newAvatar}" alt="${newName}" style="width:80px;height:80px;border-radius:50%;border:3px solid #1a2a6c;margin-bottom:10px;">
                            <h3 style="margin-bottom:5px;color:#1a2a6c">${newName}</h3>
                            <p style="color:#666">${newLocation}</p>
                            <p style="color:#888;margin-top:10px;font-size:0.9rem">纬度: ${newPos[0].toFixed(4)}<br>经度: ${newPos[1].toFixed(4)}</p>
                        </div>
                    `);
                    
                    const newLine = L.polyline([newPos, offsetPosition], {
                        color: '#ff6b6b',
                        weight: 3,
                        dashArray: '10, 5'
                    }).addTo(map);
                    
                    animateConnectionLine(newLine, newPos, offsetPosition);
                    
                    // 更新数组
                    markerData.avatarMarker = newAvatarMarker;
                    markerData.line = newLine;
                    pointData.locationPoint = newLocationPoint;
                }
            }
            
            // 更新其他字段
            friend.name = newName;
            friend.avatar = newAvatar;
            
            // 刷新列表
            updateFriendsList(document.getElementById('friend-search').value);
            localStorage.setItem('friends', JSON.stringify(friends));
            
            // 关闭模态框
            closeEditModal();
        }
        
        // 事件监听
        document.getElementById('add-friend-btn').addEventListener('click', async () => {
            const name = document.getElementById('friend-name').value;
            const location = document.getElementById('location').value;
            
            if (!name || !location) {
                alert('请填写好友姓名和位置');
                return;
            }
            
            await addFriend(name, selectedAvatar, location);
        });
        
        document.querySelector('.close-btn').addEventListener('click', () => {
            document.querySelector('.map-overlay').style.display = 'none';
        });
        
        document.getElementById('add-location-btn').addEventListener('click', () => {
            document.querySelector('.map-overlay').style.display = 'block';
        });
        
        document.getElementById('reset-map-btn').addEventListener('click', () => {
            map.flyTo([30, 0], 2, {
                animate: true,
                duration: 1.5
            });
        });
        
        // 头像上传处理
        document.getElementById('avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedAvatar = event.target.result;
                    const preview = document.getElementById('avatar-preview');
                    preview.src = selectedAvatar;
                    preview.style.display = 'block';
                    document.querySelector('.avatar-preview .placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 编辑头像上传处理
        document.getElementById('edit-avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('edit-avatar-preview');
                    preview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 管理员登录
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'flex';
        });
        
        document.querySelector('.modal-close').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'none';
        });
        
        document.getElementById('login-submit').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            if (password === '5201314') {
                isAdmin = true;
                document.getElementById('login-modal').style.display = 'none';
                updateAdminUI();
                updateFriendsList();
                alert('您已进入管理员模式，可以编辑和删除好友信息');
            } else {
                alert('管理员密码错误！');
            }
        });
        
        // 保存编辑
        document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        
        // 好友操作事件委托
        document.getElementById('friends-list').addEventListener('click', async (e) => {
            if (!isAdmin) return;
            
            const target = e.target;
            const btn = target.closest('.action-btn');
            if (!btn) return;
            
            const id = parseInt(btn.dataset.id);
            const friend = friends.find(f => f.id === id);
            
            if (!friend) return;
            
            if (btn.classList.contains('delete-btn')) {
                if (confirm('确定要删除这个好友吗？')) {
                    deleteFriend(id);
                }
            } else if (btn.classList.contains('edit-btn')) {
                openEditModal(friend);
            }
        });
        
        // 地图切换功能
        document.querySelectorAll('.map-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // 移除所有图层
                Object.values(mapLayers).forEach(layer => {
                    map.removeLayer(layer);
                });
                
                // 添加选中的图层
                mapLayers[type].addTo(map);
                
                // 更新按钮状态
                document.querySelectorAll('.map-type-btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
        
        // 好友搜索功能
        document.getElementById('friend-search').addEventListener('input', function() {
            updateFriendsList(this.value);
        });
        
        // 生成分享链接
        function generateShareLink() {
            const center = map.getCenter();
            const zoom = map.getZoom();
            return `${window.location.href.split('?')[0]}?lat=${center.lat}&lng=${center.lng}&zoom=${zoom}`;
        }

        // 页面加载时解析URL参数
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.has('lat')) {
            map.flyTo([parseFloat(urlParams.get('lat')), parseFloat(urlParams.get('lng'))], parseInt(urlParams.get('zoom')));
        }

        // 分享按钮事件
        document.getElementById('share-btn').onclick = function() {
            const link = generateShareLink();
            document.getElementById('share-link').value = link;
            document.getElementById('share-panel').style.display = 'block';
        };

        // 复制链接
        function copyShareLink() {
            const input = document.getElementById('share-link');
            input.select();
            input.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('分享链接已复制！');
        }

        // 点击空白处关闭分享面板
        document.addEventListener('click', function(e){
            const panel = document.getElementById('share-panel');
            const btn = document.getElementById('share-btn');
            if(panel.style.display === 'block' && !panel.contains(e.target) && e.target !== btn){
                panel.style.display = 'none';
            }
        });

        // 社交分享
        document.getElementById('wechat-share').onclick = function(e){
            e.preventDefault();
            alert('请手动复制链接到微信');
        };
        document.getElementById('qq-share').onclick = function(e){
            e.preventDefault();
            alert('请手动复制链接到QQ');
        };
        
        // 初始化
        initializeFriends();
        
        // 添加浮动元素动画
        function createFloatingElements() {
            const container = document.querySelector('.container');
            for (let i = 0; i < 15; i++) {
                const el = document.createElement('div');
                el.className = 'floating-element';
                el.style.left = `${Math.random() * 100}%`;
                el.style.top = `${Math.random() * 100}%`;
                el.style.width = `${10 + Math.random() * 30}px`;
                el.style.height = el.style.width;
                el.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(el);
            }
        }
        
        createFloatingElements();
    </script>
</body>
</html>