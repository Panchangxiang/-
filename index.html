<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友世界地图 - GitHub同步版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .sync-options {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }
        
        .sync-options.active {
            display: block;
        }
        
        .sync-options h3 {
            color: #1a2a6c;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .sync-option {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-option:hover {
            background: #f0f7ff;
            border-color: #3498db;
        }
        
        .sync-option.active {
            background: #1a2a6c;
            color: white;
            border-color: #1a2a6c;
        }
        
        .sync-option i {
            font-size: 1.5rem;
        }
        
        .sync-option .sync-info {
            flex: 1;
        }
        
        .sync-option .sync-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .sync-option .sync-desc {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .config-form {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: none;
        }
        
        .config-form.active {
            display: block;
        }
        
        .config-form input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .config-form button {
            width: 100%;
            padding: 8px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .sync-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
        }
        
        .sync-btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .sync-btn:hover {
            background: #219653;
        }
        
        .sync-status {
            color: #666;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .sync-indicator .sync-spinner {
            display: none;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        .sync-mode {
            background: #3498db;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        h1 {
            color: #1a2a6c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            color: #555;
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .app-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        
        .map-container {
            flex: 3;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        #map {
            flex: 1;
            width: 100%;
            z-index: 10;
        }
        
        .map-controls {
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .friends-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 400px;
            height: 100%;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            position: relative;
        }
        
        .friends-list-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .friends-search {
            margin-bottom: 15px;
            position: relative;
        }
        
        .friends-search input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .friends-search input:focus {
            border-color: #1a2a6c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.2);
        }
        
        .friends-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100vh - 350px);
        }
        
        .friends-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .friends-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .friends-list::-webkit-scrollbar-thumb {
            background: #1a2a6c;
            border-radius: 4px;
        }
        
        .friends-list::-webkit-scrollbar-thumb:hover {
            background: #0d1a4a;
        }
        
        .friend-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .friend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #1a2a6c;
        }
        
        .friend-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            border: 3px solid #1a2a6c;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .friend-avatar .avatar-placeholder {
            font-size: 24px;
            color: #1a2a6c;
        }
        
        .friend-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .friend-name-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-name {
            font-weight: bold;
            font-size: 1.2rem;
            color: #1a2a6c;
        }
        
        .friend-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .friend-card:hover .action-btn {
            opacity: 1;
        }
        
        .edit-btn {
            background: #3498db;
            color: white;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
        }
        
        .friend-location {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .friend-location i {
            margin-right: 5px;
            color: #e74c3c;
        }
        
        .friend-card-body {
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .friend-coords {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #777;
        }
        
        .friend-coords i {
            margin-right: 8px;
            color: #3498db;
        }
        
        .friend-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transition: all 0.3s;
            z-index: 500;
        }
        
        .friend-marker:hover {
            transform: scale(1.15);
            z-index: 1000;
        }
        
        .friend-marker img {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        
        .location-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff6b6b;
            border: 2px solid white;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            z-index: 400;
        }
        
        .connection-line {
            stroke: #ff6b6b;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dash 30s linear infinite;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: 1000;
            }
        }
        
        .map-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            width: 380px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            transition: transform 0.4s ease;
        }
        
        .map-overlay:hover {
            transform: translateY(-5px);
        }
        
        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .overlay-header h3 {
            color: #1a2a6c;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        .overlay-header h3 i {
            margin-right: 10px;
        }
        
        .close-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            transform: rotate(90deg);
            background: #e74c3c;
        }
        
        .avatar-upload {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .avatar-preview {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #1a2a6c;
            margin-right: 15px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-preview .placeholder {
            color: #1a2a6c;
            font-size: 24px;
        }
        
        .upload-btn {
            flex: 1;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .upload-btn:hover {
            background: #2980b9;
        }
        
        #avatar-file {
            display: none;
        }
        
        .world-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 25rem;
            color: rgba(255, 255, 255, 0.03);
            z-index: 0;
        }
        
        .admin-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .admin-indicator {
            display: flex;
            align-items: center;
            color: #27ae60;
            font-weight: bold;
        }
        
        .admin-indicator i {
            margin-right: 5px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .login-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 30px;
            padding: 10px 20px;
            font-weight: bold;
            color: #1a2a6c;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .login-btn i {
            color: #27ae60;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #1a2a6c;
            font-size: 1.8rem;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 30px;
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .floating-element {
            position: absolute;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }
        
        .geocoding-result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .edit-modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .edit-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .map-switcher {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .map-type-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-type-btn:hover {
            background: #f8f9fa;
            border-color: #1a2a6c;
        }
        
        .map-type-btn.active {
            background: #1a2a6c;
            color: white;
            border-color: #1a2a6c;
        }
        
        .no-friends {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        
        .sync-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 8px 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .sync-btn {
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .sync-btn:hover {
            background: #219653;
        }
        
        .sync-status {
            color: #666;
            font-size: 0.85rem;
        }
        
        .sync-indicator .sync-spinner {
            display: none;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        .github-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .error-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: slideIn 0.5s, fadeOut 0.5s 4.5s forwards;
        }
        
        @keyframes slideIn {
            from { top: -100px; }
            to { top: 20px; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        
        @media (max-width: 1200px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }
            
            .friends-panel {
                max-width: 100%;
                height: 400px;
            }
            
            .friends-list {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> 好友世界地图 - 多同步方案版</h1>
            <p class="subtitle">支持多种数据同步方式，选择最适合您的方案</p>
        </header>
        
        <div class="sync-indicator">
            <button class="sync-btn" id="sync-btn">
                <i class="fas fa-sync-alt sync-spinner" id="sync-spinner"></i>
                <span id="sync-text">同步数据</span>
            </button>
            <div class="sync-status" id="sync-status">上次同步: <span id="last-sync">从未同步</span></div>
            <button class="sync-btn" id="sync-options-btn">
                <i class="fas fa-cog"></i>
                <span>同步设置</span>
            </button>
            <div class="sync-mode" id="sync-mode">本地存储</div>
        </div>
        
        <div class="sync-options" id="sync-options">
            <h3><i class="fas fa-cloud-upload-alt"></i> 选择同步方式</h3>
            
            <div class="sync-option active" data-sync="local">
                <i class="fas fa-database"></i>
                <div class="sync-info">
                    <div class="sync-name">本地存储</div>
                    <div class="sync-desc">数据保存在浏览器本地，不进行线上同步</div>
                </div>
            </div>
            
            <div class="sync-option" data-sync="firebase">
                <i class="fab fa-google"></i>
                <div class="sync-info">
                    <div class="sync-name">Firebase</div>
                    <div class="sync-desc">Google提供的实时数据库服务</div>
                </div>
            </div>
            
            <div class="sync-option" data-sync="supabase">
                <i class="fas fa-server"></i>
                <div class="sync-info">
                    <div class="sync-name">Supabase</div>
                    <div class="sync-desc">开源的Firebase替代方案</div>
                </div>
            </div>
            
            <div class="sync-option" data-sync="github">
                <i class="fab fa-github"></i>
                <div class="sync-info">
                    <div class="sync-name">GitHub</div>
                    <div class="sync-desc">通过GitHub存储库同步数据</div>
                </div>
            </div>
            
            <div class="config-form" id="firebase-config">
                <h4>Firebase配置</h4>
                <input type="text" id="firebase-apiKey" placeholder="API Key">
                <input type="text" id="firebase-authDomain" placeholder="Auth Domain">
                <input type="text" id="firebase-projectId" placeholder="Project ID">
                <input type="text" id="firebase-storageBucket" placeholder="Storage Bucket">
                <input type="text" id="firebase-messagingSenderId" placeholder="Messaging Sender ID">
                <input type="text" id="firebase-appId" placeholder="App ID">
                <button id="save-firebase-config">保存配置</button>
            </div>
            
            <div class="config-form" id="supabase-config">
                <h4>Supabase配置</h4>
                <input type="text" id="supabase-url" placeholder="项目URL">
                <input type="text" id="supabase-key" placeholder="API Key">
                <button id="save-supabase-config">保存配置</button>
            </div>
            
            <div class="config-form" id="github-config">
                <h4>GitHub配置</h4>
                <input type="text" id="github-username" placeholder="用户名">
                <input type="text" id="github-repo" placeholder="存储库名">
                <input type="text" id="github-token" placeholder="访问令牌">
                <button id="save-github-config">保存配置</button>
            </div>
        </div>
        
        <div class="app-container">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button id="add-location-btn"><i class="fas fa-plus-circle"></i> 添加位置</button>
                    <button id="reset-map-btn"><i class="fas fa-globe-americas"></i> 重置视图</button>
                    <div class="map-switcher">
                        <button class="map-type-btn active" data-type="osm">
                            <i class="fas fa-map"></i> 卫星地图
                        </button>
                        <button class="map-type-btn" data-type="satellite">
                            <i class="fas fa-satellite"></i> 标准地图
                        </button>
                        <button class="map-type-btn" data-type="terrain">
                            <i class="fas fa-mountain"></i> 地形地图
                        </button>
                    </div>
                </div>
                <div class="map-overlay">
                    <div class="overlay-header">
                        <h3><i class="fas fa-user-plus"></i> 添加好友位置</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            <div class="placeholder"><i class="fas fa-user"></i></div>
                            <img id="avatar-preview" style="display: none;">
                        </div>
                        <label class="upload-btn" for="avatar-file">
                            <i class="fas fa-upload"></i> 上传头像
                        </label>
                        <input type="file" id="avatar-file" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="friend-name"><i class="fas fa-user"></i> 好友姓名</label>
                        <input type="text" id="friend-name" placeholder="输入好友姓名">
                    </div>
                    <div class="form-group">
                        <label for="location"><i class="fas fa-map-marker-alt"></i> 位置（城市或经纬度）</label>
                        <input type="text" id="location" placeholder="例如: 北京 或 40.7128,-74.0060">
                    </div>
                    <div class="geocoding-result" id="geocoding-result" style="display: none;">
                        正在解析位置...
                    </div>
                    <button id="add-friend-btn"><i class="fas fa-plus"></i> 添加好友位置</button>
                </div>
                <i class="fas fa-globe-americas world-icon"></i>
            </div>
            
            <div class="friends-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-user-friends"></i> 好友列表</h2>
                    <div class="admin-indicator" id="admin-indicator" style="display: none;">
                        <i class="fas fa-user-shield"></i> 管理员模式
                    </div>
                </div>
                <div class="friends-list-container">
                    <div class="friends-search">
                        <i class="fas fa-search"></i>
                        <input type="text" id="friend-search" placeholder="搜索好友...">
                    </div>
                    <div class="friends-list" id="friends-list">
                        <!-- 好友列表会动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="login-btn" id="admin-login-btn">
        <i class="fas fa-lock"></i> 管理员登录
    </button>
    
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div class="modal-header">
                <h3>管理员登录</h3>
                <p>请输入管理员密码</p>
            </div>
            <div class="form-group">
                <input type="password" id="admin-password" placeholder="输入管理员密码">
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="login-submit">登录</button>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <div id="loading-text">正在加载数据，请稍候...</div>
    </div>
    
    <div class="edit-modal" id="edit-modal" style="display: none;">
        <div class="edit-modal-content">
            <span class="edit-modal-close" onclick="closeEditModal()">&times;</span>
            <div class="modal-header">
                <h3>编辑好友信息</h3>
            </div>
            <div class="avatar-upload">
                <div class="avatar-preview">
                    <img id="edit-avatar-preview">
                </div>
                <label class="upload-btn" for="edit-avatar-file">
                    <i class="fas fa-upload"></i> 更换头像
                </label>
                <input type="file" id="edit-avatar-file" accept="image/*" style="display: none;">
            </div>
            <div class="form-group">
                <label><i class="fas fa-user"></i> 好友姓名</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-group">
                <label><i class="fas fa-map-marker-alt"></i> 位置</label>
                <input type="text" id="edit-location">
            </div>
            <div class="form-group">
                <label><i class="fas fa-lock"></i> 管理员密码验证</label>
                <input type="password" id="admin-verify">
            </div>
            <button class="modal-btn" id="save-edit-btn">保存修改</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>

        // 同步方式配置
        const SYNC_METHODS = {
            LOCAL: 'local',
            FIREBASE: 'firebase',
            SUPABASE: 'supabase',
            GITHUB: 'github'
        };
        
        // 当前同步方式
        let currentSyncMethod = SYNC_METHODS.LOCAL;
        
        // 同步配置
        let syncConfig = {
            firebase: {
                apiKey: "AIzaSyBRMMZkpt8DzT8V7pni9wASCnPJ3GuSD5w",
                authDomain: "ee-panchangxiang.firebaseapp.com",
                projectId: "ee-panchangxiang",
                storageBucket: "ee-panchangxiang.firebasestorage.app",
                messagingSenderId: "274535151035",
                appId: "1:274535151035:web:62e922ade1b0013109409e"
                },
            supabase: {
                url: "https://fwhianvmezwdtyfxzkad.supabase.co",
                key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3aGlhbnZtZXp3ZHR5Znh6a2FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMTE5NTAsImV4cCI6MjA2Nzc4Nzk1MH0.h5GyBBDGTwRbieooJhHwSgdaBYpYE_4z2Ix8zOFsoR4"
            },
            github: {
                username: "Panchangxiang",
                repo: "friend-locations",
                token: "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"
            }
        };
        
        // 加载同步配置
        function loadSyncConfig() {
            const savedConfig = localStorage.getItem('syncConfig');
            if (savedConfig) {
                syncConfig = JSON.parse(savedConfig);
            }
            
            // 更新表单值
            document.getElementById('firebase-apiKey').value = syncConfig.firebase.apiKey;
            document.getElementById('firebase-authDomain').value = syncConfig.firebase.authDomain;
            document.getElementById('firebase-projectId').value = syncConfig.firebase.projectId;
            document.getElementById('firebase-storageBucket').value = syncConfig.firebase.storageBucket;
            document.getElementById('firebase-messagingSenderId').value = syncConfig.firebase.messagingSenderId;
            document.getElementById('firebase-appId').value = syncConfig.firebase.appId;
            
            document.getElementById('supabase-url').value = syncConfig.supabase.url;
            document.getElementById('supabase-key').value = syncConfig.supabase.key;
            
            document.getElementById('github-username').value = syncConfig.github.username;
            document.getElementById('github-repo').value = syncConfig.github.repo;
            document.getElementById('github-token').value = syncConfig.github.token;
        }
        
        // 保存同步配置
        function saveSyncConfig() {
            localStorage.setItem('syncConfig', JSON.stringify(syncConfig));
        }
        
        // 设置同步方式
        function setSyncMethod(method) {
            currentSyncMethod = method;
            document.getElementById('sync-mode').textContent = getSyncMethodName(method);
            localStorage.setItem('currentSyncMethod', method);
            
            // 更新UI
            document.querySelectorAll('.sync-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.sync === method) {
                    option.classList.add('active');
                }
            });
            
            // 隐藏所有配置表单
            document.querySelectorAll('.config-form').forEach(form => {
                form.classList.remove('active');
            });
        }
        
        // 获取同步方式名称
        function getSyncMethodName(method) {
            switch(method) {
                case SYNC_METHODS.LOCAL: return '本地存储';
                case SYNC_METHODS.FIREBASE: return 'Firebase';
                case SYNC_METHODS.SUPABASE: return 'Supabase';
                case SYNC_METHODS.GITHUB: return 'GitHub';
                default: return '未知';
            }
        }
        // GitHub配置（使用您提供的凭据）
        const GITHUB_USERNAME = "Panchangxiang";
        const GITHUB_REPO = "friend-locations";
        const GITHUB_TOKEN = "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";
        const FILE_PATH = "friends-data.json";
        
        // 使用代理服务器解决CORS问题
        const PROXY_URL = "https://cors-anywhere.herokuapp.com/";
        const GITHUB_API_BASE = "https://api.github.com";
        
        // 初始化地图
        const map = L.map('map').setView([30, 0], 2);
        
        // 地图图层定义
        const mapLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
            })
        };
        
        // 添加默认地图
        mapLayers.satellite.addTo(map);
        
        // 存储好友数据
        let friends = JSON.parse(localStorage.getItem('friends')) || [];
        
        // 存储标记和指引线
        const markers = [];
        const connectionLines = [];
        const locationPoints = [];
        
        // 当前选择的头像
        let selectedAvatar = null;
        
        // 管理员状态
        let isAdmin = false;
        
        // 当前编辑的好友ID
        let currentEditFriendId = null;
        
        // 上次同步时间
        let lastSyncTime = null;
        
        // 文件SHA（用于GitHub更新）
        let fileSHA = null;
        
        // 显示错误消息
        function showError(message) {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'error-alert';
            errorAlert.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <div>${message}</div>
            `;
            document.body.appendChild(errorAlert);
            
            setTimeout(() => {
                errorAlert.remove();
            }, 5000);
        }
        
        // 添加好友到地图
        function addFriendToMap(friend) {
            // 创建位置点标记
            const pointIcon = L.divIcon({
                className: 'location-point',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            const locationPoint = L.marker(friend.position, {icon: pointIcon}).addTo(map);
            
            // 创建自定义头像图标
            const avatarIcon = L.divIcon({
                className: 'friend-marker',
                html: `<img src="${friend.avatar}" alt="${friend.name}">`,
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            });
            
            // 计算偏移位置（避免同一位置重叠）
            const offsetPosition = calculateOffsetPosition(friend.position, friend.id);
            
            // 添加头像标记
            const avatarMarker = L.marker(offsetPosition, {icon: avatarIcon}).addTo(map);
            
            // 添加弹出信息
            avatarMarker.bindPopup(`
                <div style="text-align:center;padding:10px">
                    <img src="${friend.avatar}" alt="${friend.name}" style="width:80px;height:80px;border-radius:50%;border:3px solid #1a2a6c;margin-bottom:10px;">
                    <h3 style="margin-bottom:5px;color:#1a2a6c">${friend.name}</h3>
                    <p style="color:#666">${friend.location}</p>
                    <p style="color:#888;margin-top:10px;font-size:0.9rem">纬度: ${friend.position[0].toFixed(4)}<br>经度: ${friend.position[1].toFixed(4)}</p>
                </div>
            `);
            
            // 添加指引线
            const line = L.polyline([friend.position, offsetPosition], {
                color: '#ff6b6b',
                weight: 3,
                dashArray: '10, 5'
            }).addTo(map);
            
            // 动画效果
            animateConnectionLine(line, friend.position, offsetPosition);
            
            // 保存到数组
            markers.push({avatarMarker, line, id: friend.id});
            locationPoints.push({locationPoint, id: friend.id});
        }
        
        // 计算偏移位置（避免同一位置重叠）
        function calculateOffsetPosition(position, id) {
            const sameLocationFriends = friends.filter(f => 
                f.position[0].toFixed(4) === position[0].toFixed(4) && 
                f.position[1].toFixed(4) === position[1].toFixed(4)
            );
            
            const index = sameLocationFriends.findIndex(f => f.id === id);
            const count = sameLocationFriends.length;
            
            // 偏移角度和距离
            const angle = (index * 360) / count;
            const distance = 0.1; // 偏移距离（度）
            
            // 将角度转换为弧度
            const radian = angle * Math.PI / 180;
            
            // 计算偏移位置
            const offsetLat = position[0] + distance * Math.sin(radian);
            const offsetLng = position[1] + distance * Math.cos(radian);
            
            return [offsetLat, offsetLng];
        }
        
        // 指引线动画效果
        function animateConnectionLine(line, startPos, endPos) {
            // 设置初始位置
            line.setLatLngs([startPos, startPos]);
            
            // 动画移动到实际位置
            setTimeout(() => {
                line.setLatLngs([startPos, endPos]);
            }, 1000);
        }
        
        // 添加好友到列表
        function addFriendToList(friend) {
            const friendsList = document.getElementById('friends-list');
            
            const friendCard = document.createElement('div');
            friendCard.className = 'friend-card';
            friendCard.dataset.id = friend.id;
            friendCard.innerHTML = `
                <div class="friend-card-header">
                    <div class="friend-avatar">
                        <img src="${friend.avatar}" alt="${friend.name}">
                    </div>
                    <div class="friend-info">
                        <div class="friend-name-container">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-actions">
                                <button class="action-btn edit-btn" data-id="${friend.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" data-id="${friend.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="friend-card-body">
                    <div class="friend-location">
                        <i class="fas fa-map-marker-alt"></i> ${friend.location}
                    </div>
                    <div class="friend-coords">
                        <i class="fas fa-location-dot"></i> 
                        纬度: ${friend.position[0].toFixed(4)}, 经度: ${friend.position[1].toFixed(4)}
                    </div>
                    <div class="friend-coords">
                        <i class="fas fa-calendar-alt"></i> 
                        添加时间: ${new Date(friend.id).toLocaleDateString()}
                    </div>
                </div>
            `;
            
            // 设置操作按钮的可见性
            const actions = friendCard.querySelector('.friend-actions');
            actions.style.display = isAdmin ? 'flex' : 'none';
            
            friendCard.addEventListener('click', (e) => {
                if (!e.target.closest('.action-btn')) {
                    map.flyTo(friend.position, 5, {
                        animate: true,
                        duration: 1.5
                    });
                    
                    setTimeout(() => {
                        const marker = markers.find(m => m.id === friend.id)?.avatarMarker;
                        if (marker) marker.openPopup();
                    }, 1600);
                }
            });
            
            friendsList.appendChild(friendCard);
        }
        
        // 更新好友列表
        function updateFriendsList(searchTerm = '') {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '';
            
            // 按名称首字母排序
            const sortedFriends = [...friends].sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            // 过滤好友
            const filteredFriends = sortedFriends.filter(friend => {
                if (!searchTerm) return true;
                return friend.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       friend.location.toLowerCase().includes(searchTerm.toLowerCase());
            });
            
            if (filteredFriends.length === 0) {
                friendsList.innerHTML = `
                    <div class="no-friends">
                        <i class="fas fa-user-slash" style="font-size:3rem;margin-bottom:15px;"></i>
                        <h3>没有找到匹配的好友</h3>
                        <p>尝试使用不同的搜索词</p>
                    </div>
                `;
                return;
            }
            
            filteredFriends.forEach(friend => addFriendToList(friend));
        }
        
        // 更新管理员UI
        function updateAdminUI() {
            document.getElementById('admin-login-btn').style.display = isAdmin ? 'none' : 'block';
            
            // 显示管理员指示器
            document.getElementById('admin-indicator').style.display = isAdmin ? 'flex' : 'none';
            
            // 更新好友卡片中的操作按钮
            document.querySelectorAll('.friend-actions').forEach(actions => {
                actions.style.display = isAdmin ? 'flex' : 'none';
            });
        }
        
        // 地理编码函数 - 将中文地址转换为经纬度
        async function geocodeAddress(address) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在解析位置...';
            document.getElementById('geocoding-result').style.display = 'block';
            document.getElementById('geocoding-result').textContent = '正在解析位置...';
            
            try {
                // 使用Nominatim地理编码服务
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
                );
                
                if (!response.ok) {
                    throw new Error('地理编码服务请求失败');
                }
                
                const data = await response.json();
                
                if (data.length === 0) {
                    throw new Error('未找到匹配的位置');
                }
                
                // 获取第一个结果
                const firstResult = data[0];
                const lat = parseFloat(firstResult.lat);
                const lon = parseFloat(firstResult.lon);
                
                document.getElementById('geocoding-result').textContent = 
                    `解析成功: ${firstResult.display_name || address}`;
                
                return [lat, lon];
            } catch (error) {
                document.getElementById('geocoding-result').textContent = 
                    `解析失败: ${error.message || '未知错误'}`;
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 安全的Base64编码函数，支持非Latin1字符
        function safeBtoa(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode(parseInt(p1, 16));
            }));
        }

        // 安全的Base64解码函数，支持非Latin1字符
        function safeAtob(str) {
            return decodeURIComponent(atob(str).split('').map(c => {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }
        
        
        // 从GitHub获取数据
        async function fetchDataFromGitHub() {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在从GitHub加载数据...';
            
            try {
                const response = await fetch(
                    `${PROXY_URL}${GITHUB_API_BASE}/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${FILE_PATH}`,
                    {
                        headers: {
                            Authorization: `token ${GITHUB_TOKEN}`,
                            Accept: 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    throw new Error(`GitHub请求失败: ${response.status} - ${errorDetails}`);
                }
                
                const data = await response.json();
                
                if (!data.content) {
                    throw new Error('GitHub响应中没有文件内容');
                }
                
                // 保存文件SHA用于后续更新
                fileSHA = data.sha;
                
                // 解码Base64内容
                const decodedContent = safeAtob(data.content);
                return JSON.parse(decodedContent);
            } catch (error) {
                console.error("GitHub数据加载失败:", error);
                showError(`无法从GitHub加载数据: ${error.message}`);
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        /*
        // 保存数据到GitHub
        async function saveDataToGitHub(data) {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在保存数据到GitHub...';
            
            try {
                const content = safeBtoa(JSON.stringify(data));
                const commitMessage = `更新好友数据 - ${new Date().toLocaleString()}`;
                
                const requestData = {
                    message: commitMessage,
                    content: content,
                    sha: fileSHA, // 如果存在SHA则更新文件
                    branch: "main"
                };
                
                const response = await fetch(
                    `${PROXY_URL}${GITHUB_API_BASE}/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${FILE_PATH}`,
                    {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${GITHUB_TOKEN}`,
                            'Content-Type': 'application/json',
                            Accept: 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(requestData)
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`保存失败: ${errorData.message || response.statusText}`);
                }
                
                const result = await response.json();
                fileSHA = result.content.sha; // 更新SHA
                
                // 更新同步时间
                lastSyncTime = new Date();
                document.getElementById('last-sync').textContent = lastSyncTime.toLocaleTimeString();
                
                return result;
            } catch (error) {
                console.error("保存数据到GitHub失败:", error);
                showError(`保存失败: ${error.message}`);
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        */
        // 使用Firebase保存数据
        async function saveDataToFirebase(data) {
            // 实现Firebase保存逻辑
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在保存数据到Firebase...';
            
            try {
                // 这里应该是实际的Firebase保存逻辑
                // 模拟保存过程
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 更新同步时间
                lastSyncTime = new Date();
                document.getElementById('last-sync').textContent = lastSyncTime.toLocaleTimeString();
                
                return true;
            } catch (error) {
                console.error("保存数据到Firebase失败:", error);
                showError(`保存失败: ${error.message}`);
                return false;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 从Firebase获取数据
        async function fetchDataFromFirebase() {
            // 实现Firebase获取逻辑
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在从Firebase加载数据...';
            
            try {
                // 这里应该是实际的Firebase获取逻辑
                // 模拟获取过程
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 返回本地数据作为模拟
                const localData = JSON.parse(localStorage.getItem('friends')) || [];
                return localData;
            } catch (error) {
                console.error("从Firebase加载数据失败:", error);
                showError(`加载失败: ${error.message}`);
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 使用Supabase保存数据
        async function saveDataToSupabase(data) {
            // 实现Supabase保存逻辑
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在保存数据到Supabase...';
            
            try {
                // 这里应该是实际的Supabase保存逻辑
                // 模拟保存过程
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 更新同步时间
                lastSyncTime = new Date();
                document.getElementById('last-sync').textContent = lastSyncTime.toLocaleTimeString();
                
                return true;
            } catch (error) {
                console.error("保存数据到Supabase失败:", error);
                showError(`保存失败: ${error.message}`);
                return false;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 从Supabase获取数据
        async function fetchDataFromSupabase() {
            // 实现Supabase获取逻辑
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在从Supabase加载数据...';
            
            try {
                // 这里应该是实际的Supabase获取逻辑
                // 模拟获取过程
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // 返回本地数据作为模拟
                const localData = JSON.parse(localStorage.getItem('friends')) || [];
                return localData;
            } catch (error) {
                console.error("从Supabase加载数据失败:", error);
                showError(`加载失败: ${error.message}`);
                return null;
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 保存数据（根据当前同步方式）
        async function saveData(data) {
            switch(currentSyncMethod) {
                case SYNC_METHODS.FIREBASE:
                    return await saveDataToFirebase(data);
                case SYNC_METHODS.SUPABASE:
                    return await saveDataToSupabase(data);
                case SYNC_METHODS.GITHUB:
                    return await saveDataToGitHub(data);
                case SYNC_METHODS.LOCAL:
                default:
                    localStorage.setItem('friends', JSON.stringify(data));
                    return true;
            }
        }
        
        // 获取数据（根据当前同步方式）
        async function fetchData() {
            switch(currentSyncMethod) {
                case SYNC_METHODS.FIREBASE:
                    return await fetchDataFromFirebase();
                case SYNC_METHODS.SUPABASE:
                    return await fetchDataFromSupabase();
                case SYNC_METHODS.GITHUB:
                    return await fetchDataFromGitHub();
                case SYNC_METHODS.LOCAL:
                default:
                    return JSON.parse(localStorage.getItem('friends')) || [];
            }
        }
        


        // 添加好友
        async function addFriend(name, avatar, location) {
            // 显示加载状态
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在添加好友...';
            
            try {
                let position = null;
                
                // 检查输入是否是经纬度
                if (location.includes(',')) {
                    const coords = location.split(',').map(coord => parseFloat(coord.trim()));
                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        position = coords;
                    }
                }
                
                // 如果不是经纬度，则进行地理编码
                if (!position) {
                    position = await geocodeAddress(location);
                    
                    if (!position) {
                        alert('无法解析位置，请检查输入或稍后再试');
                        return;
                    }
                }
                
                const friend = {
                    id: Date.now(),
                    name: name,
                    avatar: avatar || `https://ui-avatars.com/api/?name=${name}&background=1a2a6c&color=fff`,
                    location: location,
                    position: position
                };
                
                friends.push(friend);
                
                // 保存到本地存储
                localStorage.setItem('friends', JSON.stringify(friends));
                
                // 保存到GitHub
                await saveDataToGitHub(friends);
                
                addFriendToMap(friend);
                updateFriendsList();
                
                // 动画效果
                map.flyTo(position, 5, {
                    animate: true,
                    duration: 1.5
                });
                
                // 重置表单
                document.getElementById('friend-name').value = '';
                document.getElementById('location').value = '';
                document.getElementById('avatar-preview').style.display = 'none';
                document.querySelector('.avatar-preview .placeholder').style.display = 'block';
                selectedAvatar = null;
                
                // 隐藏地理编码结果
                setTimeout(() => {
                    document.getElementById('geocoding-result').style.display = 'none';
                }, 3000);
                
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 删除好友
        async function deleteFriend(id) {
            if (!confirm('确定要删除这个好友吗？')) return;
            
            // 显示加载状态
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在删除好友...';
            
            try {
                friends = friends.filter(friend => friend.id !== id);
                
                // 保存到本地存储
                localStorage.setItem('friends', JSON.stringify(friends));
                
                // 保存到GitHub
                await saveDataToGitHub(friends);
                
                // 从地图上删除
                const markerIndex = markers.findIndex(m => m.id === id);
                if (markerIndex !== -1) {
                    map.removeLayer(markers[markerIndex].avatarMarker);
                    map.removeLayer(markers[markerIndex].line);
                    markers.splice(markerIndex, 1);
                }
                
                const pointIndex = locationPoints.findIndex(p => p.id === id);
                if (pointIndex !== -1) {
                    map.removeLayer(locationPoints[pointIndex].locationPoint);
                    locationPoints.splice(pointIndex, 1);
                }
                
                // 更新列表
                updateFriendsList(document.getElementById('friend-search').value);
                
                // 显示成功提示
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.innerHTML = '<i class="fas fa-trash mr-2"></i> 好友已删除！';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
                
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 打开编辑模态框
        function openEditModal(friend) {
            currentEditFriendId = friend.id;
            document.getElementById('edit-avatar-preview').src = friend.avatar;
            document.getElementById('edit-name').value = friend.name;
            document.getElementById('edit-location').value = friend.location;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditFriendId = null;
        }
        
        // 编辑好友
        async function saveEdit() {
            if (!currentEditFriendId) return;
            
            const password = document.getElementById('admin-verify').value;
            if (password !== "5201314") {
                alert("管理员密码错误");
                return;
            }
            
            // 显示加载状态
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在保存修改...';
            
            try {
                const friendIndex = friends.findIndex(f => f.id === currentEditFriendId);
                if (friendIndex === -1) {
                    alert("找不到该好友");
                    return;
                }
                
                const originalFriend = friends[friendIndex];
                const newName = document.getElementById('edit-name').value;
                const newLocation = document.getElementById('edit-location').value;
                const newAvatar = document.getElementById('edit-avatar-preview').src;
                
                // 如果位置有变化，需要重新地理编码
                if (newLocation !== originalFriend.location) {
                    const newPos = await geocodeAddress(newLocation);
                    if (!newPos) {
                        alert('无法解析新位置，请检查输入');
                        return;
                    }
                    
                    // 更新位置
                    originalFriend.position = newPos;
                    originalFriend.location = newLocation;
                }
                
                // 更新其他字段
                originalFriend.name = newName;
                originalFriend.avatar = newAvatar;
                
                // 保存到本地存储
                localStorage.setItem('friends', JSON.stringify(friends));
                
                // 保存到GitHub
                await saveDataToGitHub(friends);
                
                // 更新地图标记
                const markerData = markers.find(m => m.id === currentEditFriendId);
                const pointData = locationPoints.find(p => p.id === currentEditFriendId);
                
                if (markerData && pointData) {
                    // 如果位置有变化，更新标记位置
                    if (newLocation !== originalFriend.location) {
                        // 移除旧标记
                        map.removeLayer(markerData.avatarMarker);
                        map.removeLayer(markerData.line);
                        map.removeLayer(pointData.locationPoint);
                        
                        // 添加新标记
                        const pointIcon = L.divIcon({
                            className: 'location-point',
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });
                        
                        const newLocationPoint = L.marker(originalFriend.position, {icon: pointIcon}).addTo(map);
                        
                        // 计算偏移位置
                        const offsetPosition = calculateOffsetPosition(originalFriend.position, originalFriend.id);
                        
                        const avatarIcon = L.divIcon({
                            className: 'friend-marker',
                            html: `<img src="${newAvatar}" alt="${newName}">`,
                            iconSize: [50, 50],
                            iconAnchor: [25, 25]
                        });
                        
                        const newAvatarMarker = L.marker(offsetPosition, {icon: avatarIcon}).addTo(map);
                        
                        newAvatarMarker.bindPopup(`
                            <div style="text-align:center;padding:10px">
                                <img src="${newAvatar}" alt="${newName}" style="width:80px;height:80px;border-radius:50%;border:3px solid #1a2a6c;margin-bottom:10px;">
                                <h3 style="margin-bottom:5px;color:#1a2a6c">${newName}</h3>
                                <p style="color:#666">${newLocation}</p>
                                <p style="color:#888;margin-top:10px;font-size:0.9rem">纬度: ${originalFriend.position[0].toFixed(4)}<br>经度: ${originalFriend.position[1].toFixed(4)}</p>
                            </div>
                        `);
                        
                        const newLine = L.polyline([originalFriend.position, offsetPosition], {
                            color: '#ff6b6b',
                            weight: 3,
                            dashArray: '10, 5'
                        }).addTo(map);
                        
                        animateConnectionLine(newLine, originalFriend.position, offsetPosition);
                        
                        // 更新数组
                        markerData.avatarMarker = newAvatarMarker;
                        markerData.line = newLine;
                        pointData.locationPoint = newLocationPoint;
                    } else {
                        // 位置没变，只更新头像
                        markerData.avatarMarker.setIcon(L.divIcon({
                            className: 'friend-marker',
                            html: `<img src="${newAvatar}" alt="${newName}">`,
                            iconSize: [50, 50],
                            iconAnchor: [25, 25]
                        }));
                        
                        // 更新弹出信息
                        markerData.avatarMarker.setPopupContent(`
                            <div style="text-align:center;padding:10px">
                                <img src="${newAvatar}" alt="${newName}" style="width:80px;height:80px;border-radius:50%;border:3px solid #1a2a6c;margin-bottom:10px;">
                                <h3 style="margin-bottom:5px;color:#1a2a6c">${newName}</h3>
                                <p style="color:#666">${newLocation}</p>
                                <p style="color:#888;margin-top:10px;font-size:0.9rem">纬度: ${originalFriend.position[0].toFixed(4)}<br>经度: ${originalFriend.position[1].toFixed(4)}</p>
                            </div>
                        `);
                    }
                }
                
                // 刷新列表
                updateFriendsList(document.getElementById('friend-search').value);
                
                // 关闭模态框
                closeEditModal();
                
                // 显示成功提示
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.innerHTML = '<i class="fas fa-check mr-2"></i> 好友信息已更新！';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
                
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 事件监听
        document.getElementById('add-friend-btn').addEventListener('click', async () => {
            const name = document.getElementById('friend-name').value;
            const location = document.getElementById('location').value;
            
            if (!name || !location) {
                alert('请填写好友姓名和位置');
                return;
            }
            
            await addFriend(name, selectedAvatar, location);
        });
        
        document.querySelector('.close-btn').addEventListener('click', () => {
            document.querySelector('.map-overlay').style.display = 'none';
        });
        
        document.getElementById('add-location-btn').addEventListener('click', () => {
            document.querySelector('.map-overlay').style.display = 'block';
        });
        
        document.getElementById('reset-map-btn').addEventListener('click', () => {
            map.flyTo([30, 0], 2, {
                animate: true,
                duration: 1.5
            });
        });
        
        // 头像上传处理
        document.getElementById('avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    selectedAvatar = event.target.result;
                    const preview = document.getElementById('avatar-preview');
                    preview.src = selectedAvatar;
                    preview.style.display = 'block';
                    document.querySelector('.avatar-preview .placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 编辑头像上传处理
        document.getElementById('edit-avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('edit-avatar-preview');
                    preview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 管理员登录
        document.getElementById('admin-login-btn').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'flex';
        });
        
        document.querySelector('.modal-close').addEventListener('click', () => {
            document.getElementById('login-modal').style.display = 'none';
        });
        
        document.getElementById('login-submit').addEventListener('click', () => {
            const password = document.getElementById('admin-password').value;
            if (password === '5201314') {
                isAdmin = true;
                document.getElementById('login-modal').style.display = 'none';
                updateAdminUI();
                updateFriendsList();
                alert('您已进入管理员模式，可以编辑和删除好友信息');
            } else {
                alert('管理员密码错误！');
            }
        });
        
        // 保存编辑
        document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
        
        // 好友操作事件委托
        document.getElementById('friends-list').addEventListener('click', async (e) => {
            if (!isAdmin) return;
            
            const target = e.target;
            const btn = target.closest('.action-btn');
            if (!btn) return;
            
            const id = parseInt(btn.dataset.id);
            const friend = friends.find(f => f.id === id);
            
            if (!friend) return;
            
            if (btn.classList.contains('delete-btn')) {
                deleteFriend(id);
            } else if (btn.classList.contains('edit-btn')) {
                openEditModal(friend);
            }
        });
        
        // 地图切换功能
        document.querySelectorAll('.map-type-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.dataset.type;
                
                // 移除所有图层
                Object.values(mapLayers).forEach(layer => {
                    map.removeLayer(layer);
                });
                
                // 添加选中的图层
                mapLayers[type].addTo(map);
                
                // 更新按钮状态
                document.querySelectorAll('.map-type-btn').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
            });
        });
        
        // 好友搜索功能
        document.getElementById('friend-search').addEventListener('input', function() {
            updateFriendsList(this.value);
        });
        
        // 同步数据功能
        document.getElementById('sync-btn').addEventListener('click', async function() {
            // 显示同步动画
            document.getElementById('sync-spinner').style.display = 'inline-block';
            document.getElementById('sync-text').textContent = '同步中...';
            
            try {
                // 从GitHub获取最新数据
                const newData = await fetchDataFromGitHub();
                if (newData) {
                    friends = newData;
                    
                    // 清空现有标记
                    markers.forEach(m => {
                        map.removeLayer(m.avatarMarker);
                        map.removeLayer(m.line);
                    });
                    locationPoints.forEach(p => map.removeLayer(p.locationPoint));
                    markers.length = 0;
                    locationPoints.length = 0;
                    
                    // 添加新数据
                    friends.forEach(friend => {
                        addFriendToMap(friend);
                    });
                    
                    updateFriendsList();
                    
                    // 更新同步时间
                    lastSyncTime = new Date();
                    document.getElementById('last-sync').textContent = lastSyncTime.toLocaleTimeString();
                    
                    // 显示成功通知
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    notification.innerHTML = '<i class="fas fa-check mr-2"></i> 数据同步成功！';
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s';
                        setTimeout(() => notification.remove(), 500);
                    }, 3000);
                }
            } catch (error) {
                console.error('同步失败:', error);
                showError('数据同步失败，请检查网络连接');
            } finally {
                // 恢复按钮状态
                document.getElementById('sync-spinner').style.display = 'none';
                document.getElementById('sync-text').textContent = '同步数据';
            }
        });
        
        // 初始化
        async function initializeApp() {
            // 加载同步配置
            loadSyncConfig();
            
            // 设置同步方式
            const savedMethod = localStorage.getItem('currentSyncMethod');
            if (savedMethod && Object.values(SYNC_METHODS).includes(savedMethod)) {
                setSyncMethod(savedMethod);
            }
            
            // 显示加载状态
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').textContent = '正在加载好友数据...';
            
            try {
                // 获取数据
                const data = await fetchData();
                
                if (data) {
                    friends = data;
                    
                    // 清空现有标记
                    markers.forEach(m => {
                        map.removeLayer(m.avatarMarker);
                        map.removeLayer(m.line);
                    });
                    locationPoints.forEach(p => map.removeLayer(p.locationPoint));
                    markers.length = 0;
                    locationPoints.length = 0;
                    
                    // 添加新数据
                    friends.forEach(friend => {
                        addFriendToMap(friend);
                    });
                    
                    updateFriendsList();
                    
                    // 更新同步时间
                    lastSyncTime = new Date();
                    document.getElementById('last-sync').textContent = lastSyncTime.toLocaleTimeString();
                }
                
            } finally {
                // 隐藏加载状态
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
        
        // 事件监听
        document.getElementById('sync-options-btn').addEventListener('click', () => {
            document.getElementById('sync-options').classList.toggle('active');
        });
        
        // 同步选项点击
        document.querySelectorAll('.sync-option').forEach(option => {
            option.addEventListener('click', function() {
                const method = this.dataset.sync;
                setSyncMethod(method);
                
                // 显示对应配置表单
                if (method !== SYNC_METHODS.LOCAL) {
                    document.getElementById(`${method}-config`).classList.add('active');
                }
            });
        });
        
        // 保存Firebase配置
        document.getElementById('save-firebase-config').addEventListener('click', () => {
            syncConfig.firebase = {
                apiKey: document.getElementById('firebase-apiKey').value,
                authDomain: document.getElementById('firebase-authDomain').value,
                projectId: document.getElementById('firebase-projectId').value,
                storageBucket: document.getElementById('firebase-storageBucket').value,
                messagingSenderId: document.getElementById('firebase-messagingSenderId').value,
                appId: document.getElementById('firebase-appId').value
            };
            saveSyncConfig();
            alert('Firebase配置已保存！');
        });
        
        // 保存Supabase配置
        document.getElementById('save-supabase-config').addEventListener('click', () => {
            syncConfig.supabase = {
                url: document.getElementById('supabase-url').value,
                key: document.getElementById('supabase-key').value
            };
            saveSyncConfig();
            alert('Supabase配置已保存！');
        });
        
        // 保存GitHub配置
        document.getElementById('save-github-config').addEventListener('click', () => {
            syncConfig.github = {
                username: document.getElementById('github-username').value,
                repo: document.getElementById('github-repo').value,
                token: document.getElementById('github-token').value
            };
            saveSyncConfig();
            alert('GitHub配置已保存！');
        });
        
        // 同步按钮
        document.getElementById('sync-btn').addEventListener('click', async function() {
            // 显示同步动画
            document.getElementById('sync-spinner').style.display = 'inline-block';
            document.getElementById('sync-text').textContent = '同步中...';
            
            try {
                // 保存数据
                await saveData(friends);
                
                // 显示成功通知
                showNotification('数据同步成功！', 'success');
                
            } catch (error) {
                console.error('同步失败:', error);
                showError('数据同步失败，请检查网络连接');
            } finally {
                // 恢复按钮状态
                document.getElementById('sync-spinner').style.display = 'none';
                document.getElementById('sync-text').textContent = '同步数据';
            }
        });
        
        // 初始化应用
        initializeApp();
        
        // 添加浮动元素动画
        function createFloatingElements() {
            const container = document.querySelector('.container');
            for (let i = 0; i < 15; i++) {
                const el = document.createElement('div');
                el.className = 'floating-element';
                el.style.left = `${Math.random() * 100}%`;
                el.style.top = `${Math.random() * 100}%`;
                el.style.width = `${10 + Math.random() * 30}px`;
                el.style.height = el.style.width;
                el.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(el);
            }
        }
        
        createFloatingElements();
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 ${
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white px-4 py-2 rounded-lg shadow-lg z-50`;
            notification.innerHTML = `<i class="fas fa-${
                type === 'success' ? 'check' : 'info-circle'
            } mr-2"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>